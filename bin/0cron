#!/usr/bin/perl

# List all scripts that have been run from cron lately.
#
# This works by scanning the cron-run-logs, typically contained in something
# like:
#       /var/log/syslog     (grep for 'cron')
#       /var/log/cron
#       /var/log/messages   (grep for 'cron')
#       journalctl

    use strict;
    use warnings;

    use Text::ParseWords;

    use Data::Printer;


my %seen;

# There are several different places that cron executions can be logged.
########################################################
if (-e '/var/log/cron') {

    open my $fh, '<', '/var/log/cron'       or die $!;

    while (<$fh>) {
        chomp;
        if (s/^.*: \([^\s\)]*\) CMD \(//) {
            s/\)$//;
            #print ">> $_\n";

            my @cmd = Text::ParseWords::shellwords( $_ );
            #p @cmd;

            if ($cmd[0] =~ m#^/# && (-f $cmd[0] || -l $cmd[0])) {
                process_command( $cmd[0] );
            }
        }
    }

########################################################
} else {

    die "No cron logs found.\n";

}



sub process_command {
    my ($command) = @_;

    if (-l $command) {
        my $symlink_target = readlink( $command );
        return unless (-f $symlink_target);
        return if ($seen{$symlink_target}++);
    }

    if (-T $command) {
        if (! $seen{$command}++) {
            print "$command\0";
        }
    }
}
